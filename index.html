<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Spotify Beat Visualizer â€“ iPad</title>
  <style>
    :root { --bg:#0a0b0f; --fg:#e5e7eb; --muted:#9ca3af; --accent:#22d3ee; }
    html, body { margin:0; height:100%; background:var(--bg); color:var(--fg); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji; }
    #stage { position:fixed; inset:0; display:block; background: radial-gradient(1200px 800px at 50% 50%, #12141b 0%, #0a0b0f 60%, #07080c 100%); }
    #ui { position: fixed; left: 16px; right: 16px; top: env(safe-area-inset-top, 16px); display:flex; flex-wrap:wrap; gap:10px; align-items:center; z-index:10; backdrop-filter: blur(10px); background: rgba(10,11,15,.45); border:1px solid rgba(255,255,255,.08); padding:12px; border-radius:16px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    #ui > * { font-size:16px; }
    button, select, input[type="text"] { appearance:none; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:#11131a; color:var(--fg); padding:10px 12px; outline:none; }
    button { font-weight:600; }
    button.primary { background: linear-gradient(180deg, #11b5cc, #0ea5b1); border-color: transparent; color:#031419; }
    button.ghost { background: transparent; border-color: rgba(255,255,255,.18); }
    button:active { transform: translateY(1px); }
    #row2 { display:flex; flex:1; gap:10px; min-width: 270px; }
    #row2 input { flex:1; min-width:120px; }
    #np { font-size:14px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 48vw; }
    #dock { position: fixed; bottom: env(safe-area-inset-bottom, 16px); left: 16px; right: 16px; display:flex; justify-content:space-between; align-items:center; gap:10px; z-index:10;}
    #hints { font-size:12px; color:var(--muted); opacity:.9; }
    #tapOverlay { position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.5); color:white; z-index:20; }
    #tapOverlay .box { text-align:center; padding:28px; border-radius:20px; background:rgba(17,19,26,.8); border:1px solid rgba(255,255,255,.12); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    a { color: var(--accent); text-decoration: none; }
    details { cursor: pointer; }
  </style>
</head>
<body>
  <canvas id="stage"></canvas>

  <div id="ui">
    <button id="connect" class="primary">Connect Spotify</button>
    <button id="start" class="ghost">Start Visualizer</button>
    <label>
      Mode
      <select id="mode">
        <option value="rings">Rings</option>
        <option value="bars">Bars</option>
        <option value="particles">Particles</option>
      </select>
    </label>
    <label>
      Sensitivity
      <input id="sens" type="range" min="0.5" max="2.0" step="0.05" value="1.0" />
    </label>
    <span id="np">â€”</span>
    <div id="row2">
      <input id="uri" type="text" placeholder="Paste Spotify URL (track/album/playlist)â€¦" />
      <button id="play" class="ghost">Play</button>
      <button id="fs" class="ghost">Fullscreen</button>
    </div>

    <!-- Library + follow playback -->
    <div id="rowLib" style="display:grid; grid-template-columns: auto 1fr auto auto; gap:10px;">
      <button id="loadLib" class="ghost">Load Library</button>
      <select id="plSelect"><option>â€”</option></select>
      <button id="playPl" class="ghost">Play Playlist</button>
      <label style="display:flex; align-items:center; gap:6px;">
        <input type="checkbox" id="follow" /> Follow App Playback
      </label>
    </div>
  </div>

  <div id="dock">
    <div id="hints">
      Visuals pulse on Spotify beats + loudness.<br/>
      Debug: <span class="mono" id="dbg">â€”</span>
    </div>
    <details>
      <summary>Help</summary>
      <div style="max-width:560px; font-size:13px; line-height:1.35">
        <p><strong>Client ID & Redirect:</strong> edit <span class="mono">SPOTIFY_CLIENT_ID</span> + <span class="mono">REDIRECT_URI</span> in source.</p>
        <p><strong>Permissions:</strong> requires streaming, playback state, library access.</p>
        <p><strong>Why no raw waveform?</strong> Spotify DRM blocks PCM; we sync to beat & energy analysis.</p>
      </div>
    </details>
  </div>

  <div id="tapOverlay"><div class="box"><h2>ðŸ”Š Tap to start</h2><p>iOS needs a gesture to unlock audio.</p><button id="unlock" class="primary">Letâ€™s go</button></div></div>

  <script src="https://sdk.scdn.co/spotify-player.js"></script>
  <script>
  const SPOTIFY_CLIENT_ID = "1837421d433e4332bfc6864b03bdfeae";
  const REDIRECT_URI = "https://owcowboy.github.io/retrowave-viz/";
  const SCOPES = ["streaming","user-read-email","user-read-private","user-read-playback-state","user-modify-playback-state","user-read-currently-playing","user-library-read","playlist-read-private"];

  const $ = s=>document.querySelector(s);
  const sleep = ms=>new Promise(r=>setTimeout(r,ms));
  const log = (...a)=>{console.log(...a);const d=$('#dbg');if(d)d.textContent=a.join(' ');};
  function nowSec(){return Math.floor(Date.now()/1000);}
  const store={get(){try{return JSON.parse(localStorage.getItem('sp_tokens')||'{}')}catch{return{}}},set(v){localStorage.setItem('sp_tokens',JSON.stringify(v))},clear(){localStorage.removeItem('sp_tokens')}};
  function base64urlencode(buf){return btoa(String.fromCharCode.apply(null,new Uint8Array(buf))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'')}
  async function sha256(s){const enc=new TextEncoder().encode(s);const buf=await crypto.subtle.digest('SHA-256',enc);return base64urlencode(buf)}
  function randomString(len=64){const a=new Uint8Array(len);crypto.getRandomValues(a);return Array.from(a,b=>('0'+b.toString(16)).slice(-2)).join('')}

  async function authStart(){const v=randomString(64);const c=await sha256(v);localStorage.setItem('pkce_verifier',v);const u=new URL('https://accounts.spotify.com/authorize');u.searchParams.set('client_id',SPOTIFY_CLIENT_ID);u.searchParams.set('response_type','code');u.searchParams.set('redirect_uri',REDIRECT_URI);u.searchParams.set('code_challenge_method','S256');u.searchParams.set('code_challenge',c);u.searchParams.set('scope',SCOPES.join(' '));location.assign(u.toString());}
  async function authHandleRedirect(){const p=new URLSearchParams(location.search);if(!p.has('code'))return;const code=p.get('code');history.replaceState({},'',location.pathname);const v=localStorage.getItem('pkce_verifier');const b=new URLSearchParams();b.set('client_id',SPOTIFY_CLIENT_ID);b.set('grant_type','authorization_code');b.set('code',code);b.set('redirect_uri',REDIRECT_URI);b.set('code_verifier',v);const r=await fetch('https://accounts.spotify.com/api/token',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:b});const t=await r.json();store.set({access_token:t.access_token,refresh_token:t.refresh_token,expires_at:nowSec()+t.expires_in-30});}
  async function authEnsure(){let t=store.get();if(!t.access_token)return null;if(nowSec()<(t.expires_at||0))return t;if(!t.refresh_token)return null;const b=new URLSearchParams();b.set('client_id',SPOTIFY_CLIENT_ID);b.set('grant_type','refresh_token');b.set('refresh_token',t.refresh_token);const r=await fetch('https://accounts.spotify.com/api/token',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:b});const tok=await r.json();t.access_token=tok.access_token;t.expires_at=nowSec()+tok.expires_in-30;if(tok.refresh_token)t.refresh_token=tok.refresh_token;store.set(t);return t;}

  async function apiFetch(path,opts={}){const t=await authEnsure();if(!t)throw new Error('Not authenticated');const r=await fetch('https://api.spotify.com/v1'+path,{method:opts.method||'GET',headers:{'Authorization':'Bearer '+t.access_token,'Content-Type':'application/json'},body:opts.body?JSON.stringify(opts.body):undefined});if(r.status===204)return null;if(!r.ok)throw new Error('API '+r.status);return await r.json();}
  async function transferTo(device_id){return apiFetch('/me/player',{method:'PUT',body:{device_ids:[device_id],play:true}})}
  async function playURI(uri){if(uri.startsWith('spotify:track:'))return apiFetch('/me/player/play',{method:'PUT',body:{uris:[uri]}});else return apiFetch('/me/player/play',{method:'PUT',body:{context_uri:uri}});}
  function parseSpotify(i){i=i.trim();if(!i)return null;try{const u=new URL(i);if(u.hostname.includes('open.spotify.com')){const p=u.pathname.split('/').filter(Boolean);return{type:p[0],id:p[1],uri:`spotify:${p[0]}:${p[1]}`}}}catch{}if(i.startsWith('spotify:')){const p=i.split(':');return{type:p[1],id:p[2],uri:i}}return null;}
  async function getAudioAnalysis(id){return apiFetch('/audio-analysis/'+id)}
  async function getAudioFeatures(id){return apiFetch('/audio-features/'+id)}

  let player,deviceId=null,isReady=false,currentTrackId=null,currentTrackName='â€”',analysis=null,features=null;
  let positionMs=0,paused=true,lastTs=0,followApp=false,playlists=[];
  let beatIdx=0,beats=[],bars=[],sections=[],segIdx=0,segments=[],energy=0;

  window.onSpotifyWebPlaybackSDKReady=()=>{player=new Spotify.Player({name:'Viz',getOAuthToken:async cb=>{const t=await authEnsure();if(t)cb(t.access_token);},volume:0.8});
    player.addListener('ready',({device_id})=>{deviceId=device_id;isReady=true});
    player.addListener('player_state_changed',s=>{if(!s)return;paused=s.paused;positionMs=s.position;const tr=s.track_window.current_track;const id=tr&&tr.id;if(id&&id!==currentTrackId){currentTrackId=id;currentTrackName=`${tr.name} â€” ${tr.artists.map(a=>a.name).join(', ')}`;$('#np').textContent='Now Playing: '+currentTrackName;getAudioAnalysis(id).then(a=>{analysis=a;setupBeatMap()});getAudioFeatures(id).then(f=>{features=f});}});player.connect();};
  async function startPlaybackFlow(){if(!player){alert('SDK not ready');return}if(!isReady){await sleep(300)}try{await transferTo(deviceId)}catch{}}

  function setupBeatMap(){beatIdx=0;beats=(analysis?.beats||[]).map(b=>({t:Math.round(b.start*1000),d:Math.round(b.duration*1000)}));bars=(analysis?.bars||[]).map(b=>({t:Math.round(b.start*1000),d:Math.round(b.duration*1000)}));sections=(analysis?.sections||[]).map(s=>({t:Math.round(s.start*1000),d:Math.round(s.duration*1000),k:s.key,m:s.mode,l:s.loudness}));
    const segSrc=(analysis?.segments||[]);if(segSrc.length){const loud=segSrc.map(s=>s.loudness_max??-60);const lo=Math.min(...loud),hi=Math.max(...loud);const rng=Math.max(1e-3,hi-lo);segments=segSrc.map(s=>({t:Math.round(s.start*1000),d:Math.round(s.duration*1000),e:Math.max(0,Math.min(1,((s.loudness_max??-60)-lo)/rng))}));segIdx=0;}else{segments=[];segIdx=0;}
    if(!segments.length&&features&&typeof features.energy==='number'){segments=[{t:0,d:Number.MAX_SAFE_INTEGER,e:Math.max(0,Math.min(1,features.energy))}];segIdx=0;}
  }
  function nextBeatAt(ms){while(beatIdx+1<beats.length&&beats[beatIdx+1].t<=ms){beatIdx++}const b=beats[beatIdx];return b?b.t:Infinity}
  function currentSegmentEnergy(ms){if(!segments.length)return 0.0;while(segIdx+1<segments.length&&segments[segIdx+1].t<=ms){segIdx++}const s=segments[segIdx];if(!s)return 0.0;const k=Math.min(1,Math.max(0,(ms-s.t)/Math.max(1,s.d)));return s.e*(0.7+0.3*k)}

  const canvas=$('#stage'),ctx=canvas.getContext('2d');let W=0,H=0,DPR=1;
  function resize(){DPR=Math.min(devicePixelRatio||1,2);W=canvas.width=Math.floor(innerWidth*DPR);H=canvas.height=Math.floor(innerHeight*DPR);canvas.style.width=innerWidth+'px';canvas.style.height=innerHeight+'px';ctx.imageSmoothingEnabled=true}
  addEventListener('resize',resize,{passive:true});resize();

  let mode='rings',sensitivity=1.0;$('#mode').addEventListener('change',e=>mode=e.target.value);$('#sens').addEventListener('input',e=>sensitivity=parseFloat(e.target.value));

  let beatPulse=0,barPulse=0,lastBeatT=-1;
  function draw(now){requestAnimationFrame(draw);const dt=lastTs?(now-lastTs):16;lastTs=now;if(!paused)positionMs+=dt;const nb=nextBeatAt(positionMs);if(positionMs>=nb&&nb!==lastBeatT){beatPulse=1.0;lastBeatT=nb}beatPulse*=0.92;if(beatPulse<0.02)beatPulse=0;if(bars.length){const bar=bars.filter(b=>b.t<=positionMs).slice(-1)[0];if(bar&&(positionMs-bar.t)<50)barPulse=1.0}barPulse*=0.96;
    // energy + pulse
    const targetE=currentSegmentEnergy(positionMs);energy+=(targetE-energy)*0.15;const pulse=(0.65*beatPulse*sensitivity)+(0.55*energy);
    ctx.globalCompositeOperation='source-over';ctx.fillStyle='rgba(10,11,15,0.25)';ctx.fillRect(0,0,W,H);
    const cx=W/2,cy=H/2,baseR=Math.min(W,H)*0.22,t=now*0.001;
    switch(mode){case 'rings':drawRings(cx,cy,baseR,t,pulse);break;case 'bars':drawBars(cx,cy,baseR,t,pulse);break;case 'particles':drawParticles(cx,cy,baseR,t,pulse);break;}
  }
  requestAnimationFrame(draw);

  function hueShift(t,s=0.7,l=0.55){const h=((t*40+3600)%360);return`hsl(${h} ${s*100}% ${l*100}%)`;}
  function drawRings(cx,cy,r,t,pulse){for(let i=0;i<4;i++){const rr=r*(1+i*0.18+0.05*Math.sin(t*1.2+i));const w=6*DPR+i*1.5*DPR+12*pulse;ctx.beginPath();ctx.arc(cx,cy,rr,0,Math.PI*2);ctx.strokeStyle=hueShift(t+i*0.13,0.9,0.6);ctx.globalAlpha=0.55+0.30*Math.sin(t*0.7+i)+0.60*pulse;ctx.lineWidth=w;
